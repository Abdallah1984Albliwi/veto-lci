<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>VETO Session</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%230f172a'/><circle cx='50' cy='50' r='30' fill='%238b5cf6'/></svg>"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);color:#fff;height:100vh;overflow:hidden}
.loading-overlay{position:fixed;inset:0;background:rgba(15,23,42,0.98);backdrop-filter:blur(10px);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center}
.spinner{width:60px;height:60px;border:3px solid rgba(139,92,246,0.2);border-top-color:#8b5cf6;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:1.5rem}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:1.1rem;color:#94a3b8;font-weight:500}
.container{height:100vh;display:flex;flex-direction:column}
.header{background:rgba(15,23,42,0.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(139,92,246,0.2);padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center}
.session-info{display:flex;align-items:center;gap:2rem}
.session-id{font-size:1.2rem;font-weight:700;color:#8b5cf6;letter-spacing:2px}
.participants{display:flex;align-items:center;gap:0.8rem;background:rgba(139,92,246,0.1);padding:0.5rem 1rem;border-radius:12px}
.participants-count{font-size:1.1rem;font-weight:700;color:#8b5cf6}
.user-badge{background:rgba(6,182,212,0.15);border:1px solid rgba(6,182,212,0.3);color:#06b6d4;padding:0.5rem 1rem;border-radius:10px;font-size:0.85rem;font-weight:600;display:flex;align-items:center;gap:0.5rem}
.header-actions{display:flex;gap:1rem;align-items:center}
.lang-btn,.end-btn,.logout-btn{background:rgba(139,92,246,0.15);border:1px solid rgba(139,92,246,0.3);color:#8b5cf6;padding:0.5rem 1.2rem;border-radius:10px;cursor:pointer;font-weight:600;font-size:0.85rem;transition:all 0.3s}
.end-btn{background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.3);color:#ef4444}
.logout-btn{background:rgba(251,146,60,0.15);border-color:rgba(251,146,60,0.3);color:#fb923c}
.main{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:2rem;padding:2rem;overflow:hidden}
.panel{background:rgba(30,41,59,0.6);backdrop-filter:blur(20px);border:1px solid rgba(139,92,246,0.2);border-radius:24px;padding:2rem;display:flex;flex-direction:column;overflow:hidden}
.panel-header{margin-bottom:1.5rem}
.panel-title{font-size:1.4rem;font-weight:700;display:flex;align-items:center;gap:0.8rem;margin-bottom:0.5rem}
.panel-subtitle{font-size:0.9rem;color:#94a3b8}
.panel-content{flex:1;overflow-y:auto}
.panel-content::-webkit-scrollbar{width:8px}
.panel-content::-webkit-scrollbar-track{background:rgba(15,23,42,0.4);border-radius:4px}
.panel-content::-webkit-scrollbar-thumb{background:rgba(139,92,246,0.4);border-radius:4px}
textarea{width:100%;min-height:200px;background:rgba(15,23,42,0.6);border:1px solid rgba(139,92,246,0.3);color:#fff;padding:1.5rem;border-radius:16px;font-size:1rem;font-family:inherit;resize:vertical;line-height:1.7}
textarea:focus{outline:none;border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,0.15)}
.send-btn{background:linear-gradient(135deg,#8b5cf6,#06b6d4);color:#fff;border:none;padding:1rem 2rem;border-radius:14px;font-weight:600;cursor:pointer;width:100%;margin-top:1rem;transition:all 0.3s}
.send-btn:hover:not(:disabled){transform:translateY(-2px)}
.send-btn:disabled{opacity:0.5}
.status{font-size:0.85rem;color:#64748b;margin-top:0.8rem;min-height:20px}
.collective-display{background:rgba(15,23,42,0.6);border:1px solid rgba(139,92,246,0.25);border-radius:16px;padding:2rem;min-height:300px;font-size:1.05rem;line-height:1.9;color:#e2e8f0;white-space:pre-wrap}
.collective-display.empty{display:flex;align-items:center;justify-content:center;color:#64748b;font-style:italic}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.95);backdrop-filter:blur(15px);z-index:1000;display:none;align-items:center;justify-content:center;padding:2rem}
.modal-overlay.show{display:flex}
.modal{background:linear-gradient(135deg,rgba(30,41,59,0.98),rgba(15,23,42,0.98));border:2px solid rgba(139,92,246,0.4);border-radius:24px;padding:3rem;max-width:500px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.8);position:relative}
.modal-icon{font-size:4rem;text-align:center;margin-bottom:1.5rem}
.modal h3{color:#fff;font-size:1.8rem;margin-bottom:1rem;font-weight:700;text-align:center}
.modal p{color:#94a3b8;margin-bottom:2rem;line-height:1.7;text-align:center;font-size:0.95rem}
.modal-btns{display:flex;flex-direction:column;gap:1rem}
.modal-btn{padding:1rem;border-radius:12px;font-weight:600;cursor:pointer;transition:all 0.3s;border:none;font-size:0.95rem;text-align:center;width:100%}
.modal-btn.primary{background:linear-gradient(135deg,#8b5cf6,#06b6d4);color:#fff}
.modal-btn.secondary{background:rgba(139,92,246,0.15);color:#8b5cf6;border:1px solid rgba(139,92,246,0.3)}
.modal-btn.danger{background:#ef4444;color:#fff}
.modal-btn:hover{transform:translateY(-2px)}
.login-modal .modal{max-width:400px}
.google-btn{background:#fff;color:#333;display:flex;align-items:center;justify-content:center;gap:0.8rem;padding:1rem;border-radius:12px;border:none;cursor:pointer;font-weight:600;transition:all 0.3s;width:100%}
.google-btn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,0,0,0.3)}
.toast{position:fixed;bottom:2rem;right:2rem;background:linear-gradient(135deg,rgba(139,92,246,0.95),rgba(6,182,212,0.95));color:#fff;padding:1rem 1.5rem;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.5);z-index:10000;transform:translateY(100px);opacity:0;transition:all 0.4s;font-weight:500;max-width:300px}
.toast.show{transform:translateY(0);opacity:1}
.toast.error{background:linear-gradient(135deg,rgba(239,68,68,0.95),rgba(220,38,38,0.95))}
.toast.success{background:linear-gradient(135deg,rgba(34,197,94,0.95),rgba(22,163,74,0.95))}
@media(max-width:1024px){
.main{grid-template-columns:1fr;grid-template-rows:minmax(300px,auto) minmax(300px,1fr);gap:1.5rem;padding:1.5rem;overflow-y:auto}
.modal{padding:2rem;max-width:90%}
.header{flex-direction:column;gap:1rem;padding:1rem}
.session-info{flex-direction:column;gap:0.8rem;width:100%;align-items:center}
.header-actions{flex-wrap:wrap;justify-content:center}
.lang-btn,.end-btn,.logout-btn{padding:0.4rem 1rem;font-size:0.8rem}
.panel{padding:1.5rem;min-height:280px}
.panel-title{font-size:1.2rem}
.toast{bottom:1rem;right:1rem;left:1rem;max-width:none}
}
@media(max-width:480px){
.session-id{font-size:1rem}
.modal h3{font-size:1.4rem}
.modal-icon{font-size:3rem}
.panel{padding:1.2rem}
textarea{min-height:150px;font-size:0.95rem}
}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Preparing session...</div>
</div>

<div class="container">
  <div class="header">
    <div class="session-info">
      <div class="session-id" id="sessionId">‚Äî</div>
      <div class="participants">
        <span>üë•</span>
        <span class="participants-count" id="participantCount">0</span>
      </div>
      <div class="user-badge" id="userBadge" style="display:none">
        <span>üë§</span>
        <span id="userName">‚Äî</span>
      </div>
    </div>
    <div class="header-actions">
      <button class="lang-btn" onclick="toggleLang()" id="langBtn">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
      <button class="logout-btn" id="logoutBtn" style="display:none" onclick="logout()">Logout</button>
      <button class="end-btn" onclick="showEndModal()">End</button>
    </div>
  </div>

  <div class="main">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <span>‚úçÔ∏è</span>
          <span id="ideasTitle">Your Ideas</span>
        </div>
        <div class="panel-subtitle" id="ideasSubtitle">Share your thoughts</div>
      </div>
      <div class="panel-content">
        <input type="text" id="sessionTitle" placeholder="Session title (e.g., Product Launch Strategy)..." style="width:100%;background:rgba(15,23,42,0.6);border:1px solid rgba(139,92,246,0.3);color:#fff;padding:1rem 1.5rem;border-radius:12px;font-size:1rem;margin-bottom:1rem;font-weight:600">
        <textarea id="ideasInput" placeholder="Start typing..."></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendIdea()">
          <span id="sendBtnText">üì§ Send</span>
        </button>
        <div class="status" id="status"></div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <span>üß†</span>
          <span id="collectiveTitle">Collective Mind</span>
        </div>
        <div class="panel-subtitle" id="collectiveSubtitle">Ideas merge here</div>
      </div>
      <div class="panel-content">
        <div class="collective-display empty" id="collectiveMind">
          <span>Waiting for ideas...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- End Session Modal -->
<div class="modal-overlay" id="endModal">
  <div class="modal">
    <div class="modal-icon">üéØ</div>
    <h3 id="endTitle">Save & End Session?</h3>
    <p id="endText">Download the collective mind before ending this session for all participants.</p>
    <div class="modal-btns">
      <button class="modal-btn primary" onclick="downloadAndEnd()">
        <span id="downloadBtn">üì• Download & End Session</span>
      </button>
      <button class="modal-btn danger" onclick="confirmEnd()">
        <span id="endOnlyBtn">End Without Saving</span>
      </button>
      <button class="modal-btn secondary" onclick="closeEndModal()">
        <span id="cancelBtn">Cancel</span>
      </button>
    </div>
  </div>
</div>

<!-- Login Required Modal -->
<div class="modal-overlay login-modal" id="loginModal">
  <div class="modal">
    <div class="modal-icon">üîí</div>
    <h3 id="loginTitle">Sign In Required</h3>
    <p id="loginText">You've used 4 free sessions. Sign in with Google to continue with unlimited sessions.</p>
    <div class="modal-btns">
      <button class="google-btn" onclick="googleSignIn()">
        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        <span>Continue with Google</span>
      </button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig={apiKey:"AIzaSyAieHsN-E8-NQK8P-SrV9oWIZsBj060vNo",authDomain:"veto-d1412.firebaseapp.com",projectId:"veto-d1412",databaseURL:"https://veto-d1412-default-rtdb.asia-southeast1.firebasedatabase.app"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const auth=firebase.auth();
const WORKER="https://holy-frost-2414.abdallhalbluwi7.workers.dev";

const urlParams=new URLSearchParams(window.location.search);
const sessionId=urlParams.get('id');
let userId=null;
let currentLang=urlParams.get('lang')||'en';
let sessionCount=parseInt(localStorage.getItem('sessionCount')||'0');
let currentUser=localStorage.getItem('vetoUser');
let collectiveMindText='';

function showToast(message,type='info'){
  const toast=document.getElementById('toast');
  toast.textContent=message;
  toast.className='toast show '+(type==='error'?'error':type==='success'?'success':'');
  setTimeout(()=>toast.classList.remove('show'),3000);
}

if(!sessionId){
  showToast('No session ID','error');
  setTimeout(()=>window.location.href='index.html',2000);
}

document.getElementById('sessionId').textContent=sessionId;

// Check auth state
auth.onAuthStateChanged(user=>{
  if(user){
    currentUser=user.email;
    localStorage.setItem('vetoUser',user.email);
    document.getElementById('userBadge').style.display='flex';
    document.getElementById('userName').textContent=user.displayName||user.email.split('@')[0];
    document.getElementById('logoutBtn').style.display='block';
  }
});

// Force hide loading
setTimeout(()=>{document.getElementById('loadingOverlay').style.display='none';},2000);

// Check session limit
if(!currentUser){
  sessionCount++;
  localStorage.setItem('sessionCount',sessionCount);
  if(sessionCount>4){
    setTimeout(()=>document.getElementById('loginModal').classList.add('show'),3000);
  }
}

async function init(){
  try{
    const userRef=db.ref('sessions/'+sessionId+'/users').push();
    userId=userRef.key;
    await userRef.set({joined:Date.now()});
    await db.ref('sessions/'+sessionId+'/participants').transaction(c=>(c||0)+1);
    document.getElementById('loadingOverlay').style.display='none';
  }catch(e){
    console.error(e);
    document.getElementById('loadingOverlay').style.display='none';
  }
}

db.ref('sessions/'+sessionId+'/participants').on('value',s=>{
  document.getElementById('participantCount').textContent=s.val()||0;
});

db.ref('sessions/'+sessionId+'/collectiveMind').on('value',s=>{
  const mind=s.val();
  const display=document.getElementById('collectiveMind');
  if(mind&&mind.trim()){
    display.classList.remove('empty');
    display.textContent=mind;
    collectiveMindText=mind;
  }
});

async function sendIdea(){
  const input=document.getElementById('ideasInput');
  const idea=input.value.trim();
  if(!idea){showToast('Please write your ideas first','error');return;}
  
  const btn=document.getElementById('sendBtn');
  const status=document.getElementById('status');
  
  btn.disabled=true;
  document.getElementById('sendBtnText').textContent='‚è≥ Sending...';
  status.textContent='Merging...';
  
  try{
    await db.ref('sessions/'+sessionId+'/ideas/'+userId).push({text:idea,timestamp:Date.now()});
    
    const allIdeasSnapshot=await db.ref('sessions/'+sessionId+'/ideas').once('value');
    const allIdeas=[];
    allIdeasSnapshot.forEach(userSnap=>{
      userSnap.forEach(ideaSnap=>{allIdeas.push(ideaSnap.val().text);});
    });
    
    const sessionTitle=document.getElementById('sessionTitle').value.trim()||'General Discussion';
    
    const collectiveMindPrompt=`ÿ£ŸÜÿ™ Collective Mind (ÿßŸÑÿπŸÇŸÑ ÿßŸÑÿ¨ŸÖÿßÿπŸä) - ŸÜÿ∏ÿßŸÖ ÿ™ŸÅŸÉŸäÿ± ÿ¨ŸÖÿßÿπŸä ŸÖÿ™ŸÇÿØŸÖ Ÿäÿ¨ŸÖÿπ Ÿàÿ¨Ÿáÿßÿ™ ŸÜÿ∏ÿ± ŸÖÿ™ÿπÿØÿØÿ© (ÿ•ÿØÿßÿ±Ÿäÿ©ÿå ÿ™ŸÇŸÜŸäÿ©ÿå ÿßŸÇÿ™ÿµÿßÿØŸäÿ©ÿå ÿ™ÿ¥ÿ∫ŸäŸÑŸäÿ©ÿå ÿ•ŸÜÿ≥ÿßŸÜŸäÿ©ÿå ÿ•ÿ®ÿØÿßÿπŸäÿ©) ÿ´ŸÖ ŸäÿØŸÖÿ¨Ÿáÿß ŸÅŸä ÿ±ÿ£Ÿä Ÿàÿßÿ≠ÿØ ŸÖÿ™ÿ≤ŸÜ ŸàŸÇÿßÿ®ŸÑ ŸÑŸÑÿ™ÿ∑ÿ®ŸäŸÇ.

üéØ ŸáÿØŸÅŸÉ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä:
ŸÖÿ≥ÿßÿπÿØÿ© ÿµÿßÿ≠ÿ® ÿßŸÑÿ¨ŸÑÿ≥ÿ© ÿπŸÑŸâ ÿßÿ™ÿÆÿßÿ∞ ÿ£ŸÅÿ∂ŸÑ ŸÇÿ±ÿßÿ± ŸÖŸÖŸÉŸÜ ÿπÿ®ÿ±:
‚Ä¢ ÿßŸÑÿ™ŸÅŸÉŸäÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇŸä ÿßŸÑŸÖÿ™ÿ≥ŸÑÿ≥ŸÑ
‚Ä¢ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖÿ¥ŸÉŸÑÿ© ŸÖŸÜ ÿ≤ŸàÿßŸäÿß ŸÖÿÆÿ™ŸÑŸÅÿ©
‚Ä¢ ŸÖŸàÿßÿ≤ŸÜÿ© ÿßŸÑŸÖÿÆÿßÿ∑ÿ± ŸàÿßŸÑŸÅŸàÿßÿ¶ÿØ
‚Ä¢ ÿ™ŸÇÿØŸäŸÖ ÿ≠ŸÑŸàŸÑ ÿπŸÖŸÑŸäÿ© ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ŸÜŸÅŸäÿ∞
‚Ä¢ ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ™ÿ≠Ÿäÿ≤ÿå ÿßŸÑÿ™ŸÉÿ±ÿßÿ±ÿå ÿ£Ÿà ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑÿ≥ÿ∑ÿ≠Ÿäÿ©

üß© ÿ¢ŸÑŸäÿ© ÿßŸÑÿ™ŸÅŸÉŸäÿ±:
1. ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖÿØÿÆŸÑÿßÿ™ ÿ®ŸÖŸàÿ∂ŸàÿπŸäÿ© ŸÉÿßŸÖŸÑÿ©
2. ŸÖÿ≠ÿßŸÉÿßÿ© ÿ¢ÿ±ÿßÿ° ÿÆÿ®ÿ±ÿßÿ° ŸÖÿÆÿ™ŸÑŸÅŸäŸÜ (ÿ•ÿØÿßÿ±ÿ©ÿå ÿµŸÜÿßÿπÿ©ÿå ÿ™ŸÇŸÜŸäÿ©ÿå ŸÖŸàÿßÿ±ÿØ ÿ®ÿ¥ÿ±Ÿäÿ©ÿå ÿßŸÇÿ™ÿµÿßÿØÿå ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÜŸáÿßÿ¶Ÿä)
3. ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ŸÜŸÇÿßÿ∑ ÿßŸÑÿßÿ™ŸÅÿßŸÇ ŸàÿßŸÑÿßÿÆÿ™ŸÑÿßŸÅ
4. ÿØŸÖÿ¨ ÿßŸÑÿ£ŸÅŸÉÿßÿ± ÿßŸÑŸÖÿ™ŸàÿßŸÅŸÇÿ© Ÿàÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑŸÖÿ™ÿπÿßÿ±ÿ∂ÿ© ÿ∫Ÿäÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇŸäÿ©
5. ÿ®ŸÜÿßÿ° ÿ™ÿµŸàÿ± ÿ¥ÿßŸÖŸÑ ŸÖÿØÿπŸàŸÖ ÿ®ÿßŸÑŸÖŸÜÿ∑ŸÇ ŸàÿßŸÑÿÆÿ®ÿ±ÿ©

üè∑Ô∏è ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿ©: "${sessionTitle}"

ÿßŸÑÿ£ŸÅŸÉÿßÿ± ÿßŸÑŸÖŸÇÿØŸÖÿ©:
${allIdeas.map((idea,i)=>`${i+1}. ${idea}`).join('\n')}

ÿßŸÉÿ™ÿ® ÿßŸÑÿ¢ŸÜ ÿ±ÿ£ŸäŸãÿß ÿ¨ŸÖÿßÿπŸäŸãÿß Ÿàÿßÿ≠ÿØŸãÿß ŸÖŸàÿ≠ÿØŸãÿß (150-300 ŸÉŸÑŸÖÿ©):
‚Ä¢ Ÿàÿßÿ∂ÿ≠ ŸàŸÖÿ®ÿßÿ¥ÿ±
‚Ä¢ Ÿäÿ±ÿßÿπŸä ÿßŸÑŸàÿßŸÇÿπ ŸàÿßŸÑŸÖŸàÿßÿ±ÿØ
‚Ä¢ ŸÇÿßÿ®ŸÑ ŸÑŸÑÿ™ŸÜŸÅŸäÿ∞
‚Ä¢ ÿ≠ÿßÿ≥ŸÖ Ÿàÿ¥ÿßŸÖŸÑ

ŸÑÿß ÿ™ÿ∞ŸÉÿ± "ÿßŸÑÿ±ÿ£Ÿä ÿßŸÑÿ£ŸàŸÑ" ÿ£Ÿà "ÿßŸÑÿ±ÿ£Ÿä ÿßŸÑÿ´ÿßŸÜŸä" - ŸÅŸÇÿ∑ ÿÆŸÑÿßÿµÿ© Ÿàÿßÿ≠ÿØÿ© ÿ∞ŸÉŸäÿ©.`;
    
    const res=await fetch(WORKER,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({question:allIdeas.join('\n\n'),systemPrompt:collectiveMindPrompt})
    });
    
    const data=await res.json();
    const collectiveMind=data.choices?.[0]?.message?.content||'';
    
    await db.ref('sessions/'+sessionId+'/collectiveMind').set(collectiveMind);
    
    input.value='';
    status.textContent='‚úÖ Merged!';
    setTimeout(()=>status.textContent='',3000);
  }catch(e){
    status.textContent='‚ùå Failed';
  }finally{
    btn.disabled=false;
    document.getElementById('sendBtnText').textContent='üì§ Send';
  }
}

function showEndModal(){document.getElementById('endModal').classList.add('show');}
function closeEndModal(){document.getElementById('endModal').classList.remove('show');}

function downloadAndEnd(){
  const text=collectiveMindText||'No collective mind was formed.';
  const blob=new Blob([text],{type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='VETO-Collective-Mind-'+sessionId+'.txt';
  a.click();
  URL.revokeObjectURL(url);
  
  setTimeout(()=>confirmEnd(),500);
}

function confirmEnd(){
  db.ref('sessions/'+sessionId).update({active:false,ended:Date.now()});
  window.location.href='index.html';
}

function googleSignIn(){
  const provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
  .then(result=>{
    currentUser=result.user.email;
    localStorage.setItem('vetoUser',currentUser);
    document.getElementById('loginModal').classList.remove('show');
    showToast('Welcome! Unlimited sessions unlocked','success');
  })
  .catch(e=>showToast('Sign in failed: '+e.message,'error'));
}

function logout(){
  if(confirm('Sign out?')){
    auth.signOut();
    localStorage.removeItem('vetoUser');
    window.location.reload();
  }
}

function toggleLang(){
  currentLang=currentLang==='en'?'ar':'en';
  document.documentElement.setAttribute('dir',currentLang==='ar'?'rtl':'ltr');
  document.getElementById('langBtn').textContent=currentLang==='en'?'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©':'English';
}

init();
</script>

</body>
</html>
